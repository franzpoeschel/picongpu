# Name and Path of this Script ############################### (DO NOT change!)
export PIC_PROFILE=$(cd $(dirname $BASH_SOURCE) && pwd)"/"$(basename $BASH_SOURCE)

# User Information ################################# (edit the following lines)
#   - automatically add your name and contact to output file meta data
#   - send me a mail on batch system jobs: NONE, BEGIN, END, FAIL, REQUEUE, ALL,
#     TIME_LIMIT, TIME_LIMIT_90, TIME_LIMIT_80 and/or TIME_LIMIT_50
export MY_MAILNOTIFY="NONE"
export MY_MAIL="someone@example.com"
export MY_NAME="$(whoami) <$MY_MAIL>"

# Project Information ######################################## (edit this line)
#   - account for allocation
#   Here: select the available project which has access to qos=default.
export account=$(sacctmgr show user $USER withassoc | grep default | awk '{print $5}')

# Chose Quality of Service (=QOS) of your job.
# This sets possible runtime, maximum number of nodes and priority.
# Check for an overview (https://docs.lxp.lu/first-steps/quick_start/).
export qos="default"

# Text Editor for Tools ###################################### (edit this line)
#   - examples: "nano", "vim", "emacs -nw", "vi" or without terminal: "gedit"
#export EDITOR="nano"

# General modules #############################################################
#

module load OpenMPI/5.0.7-NVHPC-25.1-CUDA-12.6.0 # loads 21 other modules, e.g. GCC, CUDA
module load CMake/3.29.3-GCCcore-13.3.0
module load Boost/1.85.0-GCC-13.3.0
module load libpng/1.6.43-GCCcore-13.3.0
module load SciPy-bundle/2024.05-gfbf-2024a


# Cluster usage warning #######################################################
#
echo "!!!!!!!!!!!!!!!!"
echo "! On Meluxina, modules are only available on compute nodes!"
echo "! Obtain an interactive job on a node for 30 minutes by executing 'getNode'!"
echo "! On the node, source your picongpu profile again to prepare the environment!"
echo "! Attention, submission of jobs via tbg or directly via sbatch has to be performed on a login(!) node!"
echo "! (Otherwise the job will be launched on the resources of the interactive allocation)"
echo "!!!!!!!!!!!!!!!!"


# Environment #################################################################
#
export PICSRC=$HOME/src/picongpu
export PIC_EXAMPLES=$PICSRC/share/picongpu/examples
export PIC_BACKEND="cuda:80" # Nvidia A100 architecture

# Path to the required templates of the system,
# relative to the PIConGPU source code of the tool bin/pic-create.
export PIC_SYSTEM_TEMPLATE_PATH=${PIC_SYSTEM_TEMPLATE_PATH:-"etc/picongpu/meluxina-lxp"}

export PATH=$PICSRC/bin:$PATH
export PATH=$PICSRC/src/tools/bin:$PATH


# "tbg" default options #######################################################
#   - SLURM (sbatch)
#   - "gpus" queue
export TBG_SUBMIT="sbatch"
export TBG_TPLFILE="$PIC_SYSTEM_TEMPLATE_PATH/gpu.tpl"

# allocate an interactive shell for 30 minutes
function getNode() {
    if [ -z "$1" ] ; then
        numNodes=1
    else
        numNodes=$1
    fi
    if [ $numNodes -gt 1 ] ; then
        echo "The maximal number of interactive nodes in qos=test is 1." 1>&2
        return 1
    fi
    srun --time=00:30:00 --nodes=$numNodes --ntasks-per-node=4 --cpus-per-task=8 --mem=240G --hint=nomultithread -A $account -p gpu -q test --pty bash
}

# Load autocompletion for PIConGPU commands
BASH_COMP_FILE=$PICSRC/bin/picongpu-completion.bash
if [ -f $BASH_COMP_FILE ] ; then
    source $BASH_COMP_FILE
else
    echo "bash completion file '$BASH_COMP_FILE' not found." >&2
fi
