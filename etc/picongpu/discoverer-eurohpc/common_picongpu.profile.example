# Name and Path of this Script ############################### (DO NOT change!)
export PIC_PROFILE=$(cd $(dirname $BASH_SOURCE) && pwd)"/"$(basename $BASH_SOURCE)

# User Information ################################# (edit the following lines)
#   - automatically add your name and contact to output file meta data
#   - send me a mail on batch system jobs: NONE, BEGIN, END, FAIL, REQUEUE, ALL,
#     TIME_LIMIT, TIME_LIMIT_90, TIME_LIMIT_80 and/or TIME_LIMIT_50
export MY_MAILNOTIFY="NONE"
export MY_MAIL="someone@example.com"
export MY_NAME="$(whoami) <$MY_MAIL>"

if [ ! $(hostname | grep "plus") ]; then
    echo "!!!!!!!!!!!!!!!!"
    echo "! You need to be logged in to discoverer-plus in order"
    echo "! to be able to submit jobs to the GPU partition!"
    echo "!!!!!!!!!!!!!!!!"
fi

# Project Information ######################################## (edit this line)
#   - account for allocation
# Announced in onboarding e-mail.
export account=""

if [ -z "${account}" ]; then
    echo "!!!!!!!!!!!!!!!!"
    echo "! You need to set the variable \$account in your ${PIC_PROFILE}!"
    echo "! with the Slurm account name created for your accepted project!"
    echo "! The system engineers at Discoverer will provide the PI and eligible users"
    echo "! with the name of the Slurm account assigned to their project!"
    echo "!!!!!!!!!!!!!!!!"
fi

# Chose Quality of Service (=QOS) of your job.
# Announced in onboarding e-mail.
export qos=$account

# Text Editor for Tools ###################################### (edit this line)
#   - examples: "nano", "vim", "emacs -nw", "vi" or without terminal: "gedit"
#export EDITOR="nano"

# General modules #############################################################
#
module load openmpi/gcc/5/5.0.7
module load gcc/14.3.0
module load nvidia/cuda/12/12.8
module load cmake/3/3.31.4

# Self-Build Software #########################################################
#
# needs to be compiled by the user
# Check the install script at
# Nowhere
#
export PIC_LIBS=$HOME/lib
export BOOST_ROOT=$PIC_LIBS/boost

export CMAKE_PREFIX_PATH=$BOOST_ROOT:$CMAKE_PREFIX_PATH

# Environment #################################################################
#
export PICSRC=$HOME/src/picongpu
export PIC_EXAMPLES=$PICSRC/share/picongpu/examples
export PIC_BACKEND="cuda:90" # Nvidia H100, H200, GH200 architecture

# Path to the required templates of the system,
# relative to the PIConGPU source code of the tool bin/pic-create.
export PIC_SYSTEM_TEMPLATE_PATH=${PIC_SYSTEM_TEMPLATE_PATH:-"etc/picongpu/discoverer-eurohpc"}

export PATH=$PICSRC/bin:$PATH
export PATH=$PICSRC/src/tools/bin:$PATH

export PYTHONPATH=$PICSRC/lib/python:$PYTHONPATH

# "tbg" default options #######################################################
#   - SLURM (sbatch)
#   - "common" partition
export TBG_SUBMIT="sbatch"
export TBG_TPLFILE="$PIC_SYSTEM_TEMPLATE_PATH/common.tpl"
export disco_partition="common"

# allocate an interactive shell for 30 minutes
function getDevice() {
    if [ -z "$1" ] ; then
        numGPUs=1
    else
        if [ "$1" -gt 8 ] ; then
            echo "The maximal number of devices per node is 8." 1>&2
            return 1
        else
            numGPUs=$1
        fi
    fi
    srun  --time=00:30:00 --ntasks-per-node=$numGPUs --cpus-per-task=13 --gres=gpu:$numGPUs \
        --mem=$((245000 * numGPUs)) --hint=nomultithread -p ${disco_partition} --account=$account --qos=$qos --pty bash
}

function getNode() {
    if [ -z "$1" ] ; then
        numNodes=1
    else
        numNodes=$1
    fi
    if [ $numNodes -gt 1 ] ; then
        echo "There are only 2 nodes! Leave some to others." 1>&2
        return 1
    fi
    srun --time=00:30:00 --nodes=$numNodes --ntasks-per-node=8 --cpus-per-task=13 --gres=gpu:$((8 * numNodes)) \
    --hint=nomultithread -p ${disco_partition} --account=$account --qos=$qos --pty bash
}

# Load autocompletion for PIConGPU commands
BASH_COMP_FILE=$PICSRC/bin/picongpu-completion.bash
if [ -f $BASH_COMP_FILE ] ; then
    source $BASH_COMP_FILE
else
    echo "bash completion file '$BASH_COMP_FILE' not found." >&2
fi
